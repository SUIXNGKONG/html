<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <title>木子李 - 选手图片检索</title>

  <style>
    :root{
      --bg-img: url('https://img-cdn.hltv.org/gallerypicture/R3WtpF7rXq_6JieFCx4_tG.jpg?auto=compress&ixlib=java-2.1.0&m=%2Fm.png&mw=1049&mx=194&my=4662&q=75&s=355ec1de37f8129c7ab88972a0623e3b&w=7876');
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --panel: rgba(10, 14, 26, .58);
      --line: rgba(255,255,255,.14);
      --accent: #7aa2ff;
      --danger: #ff6b6b;
      --radius: 18px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      color: var(--text);
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image: var(--bg-img);
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      filter: saturate(1.05) contrast(1.05);
      transform: scale(1.03);
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(122,162,255,.30), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(200,120,255,.26), transparent 55%),
        linear-gradient(180deg, rgba(4,6,12,.72), rgba(4,6,12,.82));
      z-index:-1;
    }

    .wrap{ width:min(1100px, 92vw); margin: 26px auto 42px; }
    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    /* 顶部栏（共用） */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      padding: 18px 18px 14px;
      flex-wrap:wrap;
    }
    .brand{ display:flex; flex-direction:column; gap:10px; line-height:1.2; }
    .brand .big{ font-size: 30px; font-weight: 900; letter-spacing: .6px; }
    .brand .sub{ color: var(--muted); font-size: 14px; }

    .searchArea{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .searchArea label{ color: var(--muted); font-size: 14px; }

    .input{
      height: 44px;
      padding: 0 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      width: min(360px, 72vw);
    }
    .input::placeholder{ color: rgba(234,240,255,.55); }
    .input:focus{ border-color: rgba(122,162,255,.7); box-shadow: 0 0 0 3px rgba(122,162,255,.18); }

    .btn{
      height: 44px;
      padding: 0 14px;
      border-radius: 12px;
      border:1px solid rgba(122,162,255,.55);
      background: rgba(122,162,255,.16);
      color: var(--text);
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ background: rgba(122,162,255,.24); }
    .btn:active{ transform: translateY(1px); }

    .btn.secondary{ border-color: var(--line); background: rgba(255,255,255,.06); }
    .btn.secondary:hover{ background: rgba(255,255,255,.10); }

    .btn.danger{ border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.14); }
    .btn.danger:hover{ background: rgba(255,107,107,.22); }

    .divider{ height:1px; background: rgba(255,255,255,.10); }

    /* HOME（界面1） */
    .homeBody{ padding: 16px 18px 18px; }
    .uploadRow{ display:flex; align-items:center; justify-content:flex-start; gap:12px; flex-wrap:wrap; }
    .note{ color: var(--muted); font-size: 13px; }
    .bottomQQ{ margin-top: 20px; text-align:center; color: rgba(234,240,255,.78); font-size: 14px; padding: 12px 10px 18px; }

    /* ADMIN（界面2） */
    .adminBody{ padding: 16px 18px 18px; }
    .formGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 900px){
      .formGrid{ grid-template-columns: 1fr; }
      .brand .big{ font-size: 26px; }
    }
    .card{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding: 14px;
    }
    .card h3{ margin:0 0 10px; font-size: 15px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .help{ color: var(--muted); font-size: 12.5px; line-height: 1.55; }
    .tiny{ color: rgba(234,240,255,.60); font-size: 12px; line-height: 1.45; }

    .previewSquare{
      width: 180px;
      aspect-ratio: 1/1;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-top: 10px;
    }
    .previewSquare img{ width:100%; height:100%; object-fit: cover; display:block; }
    .ph{ color: rgba(234,240,255,.60); font-size: 12px; text-align:center; padding: 10px; }

    .fileBox{
      margin-top: 10px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .fileBox input[type="file"]{ width:100%; }

    .thumbGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){ .thumbGrid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 650px){ .thumbGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .thumb{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      aspect-ratio: 16/10;
      cursor:pointer;
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; display:block; }
    .thumb .x{
      position:absolute;
      top:8px; right:8px;
      height:28px; width:28px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.9);
      display:grid;
      place-items:center;
      font-weight:900;
      cursor:pointer;
    }
    .thumb .badge{
      position:absolute;
      left:8px; bottom:8px;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      font-size: 12px;
      color: rgba(234,240,255,.88);
    }

    .adminActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    /* PLAYER（界面3） */
    .playerBody{ padding: 16px 18px 18px; }
    .playerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      padding-bottom: 12px;
    }
    .playerTitle{ display:flex; align-items:center; gap: 12px; }
    .avatar{
      width: 76px; height: 76px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      overflow:hidden;
      background: rgba(0,0,0,.25);
    }
    .avatar img{ width:100%; height:100%; object-fit: cover; display:block; }
    .playerName{ font-size: 22px; font-weight: 900; letter-spacing:.4px; }
    .playerMeta{ color: var(--muted); font-size: 12.5px; margin-top: 2px; }

    .picsGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 10px;
    }
    @media (max-width: 820px){ .picsGrid{ grid-template-columns: 1fr; } }

    .picCard{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      cursor:pointer;
    }
    .picCard .cap{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: rgba(234,240,255,.78);
      font-size: 12.5px;
      border-top:1px solid rgba(255,255,255,.10);
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      color: var(--text);
      font-size: 13px;
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-6px); }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1000;
    }
    .modal.show{ display:flex; }
    .modal .box{
      width: min(980px, 96vw);
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
    }
    .modal img{ width:100%; height:auto; display:block; }
    .modal .bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      color: rgba(234,240,255,.8);
      font-size: 12.5px;
    }

    /* ===== 自动联想下拉（共用） ===== */
    .ac{ position: relative; width: min(360px, 72vw); }
    .ac.grow{ flex: 1; min-width: 240px; } /* 给作者上传输入框用 */
    .ac .input{ width: 100%; }

    .suggest{
      position: absolute;
      top: 48px;
      left: 0;
      width: 100%;
      display: none;
      z-index: 200;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .suggest.show{ display:block; }

    .sitem{
      padding: 10px 12px;
      cursor: pointer;
      font-size: 13.5px;
      color: rgba(234,240,255,.92);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sitem small{ color: rgba(234,240,255,.60); font-size: 12px; }
    .sitem:hover{ background: rgba(122,162,255,.18); }

    .suggestEmpty{
      padding: 10px 12px;
      color: rgba(234,240,255,.65);
      font-size: 12.5px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- 界面1：HOME -->
    <section id="view-home" class="panel" hidden>
      <div class="topbar">
        <div class="brand">
          <div class="big">木子李欢迎您</div>
          <div class="sub">搜索栏输入相关选手可获得图片</div>
          <div class="sub">上传仅作者使用</div>
        </div>

        <div class="searchArea">
          <label for="homeSearch">search</label>
          <div class="ac">
            <input id="homeSearch" class="input" placeholder="例如：monesy" autocomplete="off" />
            <div class="suggest" id="homeSuggest"></div>
          </div>
          <button id="homeSearchBtn" class="btn">搜索</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="homeBody">
        <div class="uploadRow">
          <button id="goUpload" class="btn secondary">上传（仅作者使用）</button>
          <div class="note">提示：纯静态站点，“仅作者可进”是前端口令方式（不具备服务器级安全）。</div>
        </div>
        <div class="bottomQQ">作者QQ：3058924648</div>
      </div>
    </section>

    <!-- 界面2：ADMIN（作者上传） -->
    <section id="view-admin" class="panel" hidden>
      <div class="topbar">
        <div class="brand">
          <div class="big">作者上传区</div>
          <div class="sub">输入选手名 → 上传人像与图片 → 保存</div>
        </div>
        <div class="searchArea">
          <button id="adminBack" class="btn secondary">返回首页</button>
          <button id="adminLogout" class="btn danger">退出作者模式</button>
        </div>
      </div>
      <div class="divider"></div>

      <div class="adminBody">
        <div class="formGrid">
          <!-- 左：选手信息 + 人像 -->
          <div class="card">
            <h3>1) 选手信息</h3>
            <div class="row">
              <!-- ✅ 作者上传栏也加联想 -->
              <div class="ac grow">
                <input id="playerNameInput" class="input" placeholder="输入选手名（例如：monesy）" autocomplete="off" />
                <div class="suggest" id="adminSuggest"></div>
              </div>
              <button id="loadPlayer" class="btn secondary">载入</button>
            </div>

            <div class="help" style="margin-top:10px;">
              人像（上传一次后，下次输入同名选手会自动显示已上传人像）。
            </div>

            <div class="fileBox">
              <input id="portraitFile" type="file" accept="image/*" />
              <div class="previewSquare" id="portraitPreview"><div class="ph">人像预览</div></div>
            </div>

            <div class="tiny" style="margin-top:10px;">
              保存位置：浏览器本地（localStorage）。图片很多时可能超出浏览器容量（不同浏览器限制不同）。
            </div>
          </div>

          <!-- 右：上传图片（无限制） + 右下动作按钮 -->
          <div class="card">
            <h3>2) 上传图片（无限制）</h3>
            <div class="help">
              可一次选择多张图片上传；也可多次上传追加。点击缩略图右上角“×”可删除该张。
            </div>

            <div class="fileBox">
              <input id="picsFile" type="file" accept="image/*" multiple />
              <div id="picsCount" class="tiny">当前已上传：0 张</div>
            </div>

            <div id="adminThumbs" class="thumbGrid"></div>

            <div class="adminActions">
              <button id="savePlayer" class="btn">保存</button>
              <button id="toPlayerView" class="btn secondary">预览第三界面</button>
              <button id="deletePlayer" class="btn danger">删除该选手</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 界面3：PLAYER VIEW（展示） -->
    <section id="view-player" class="panel" hidden>
      <div class="topbar">
        <div class="brand">
          <div class="big">选手图片</div>
          <div class="sub">根据作者上传内容展示</div>
        </div>

        <div class="searchArea">
          <label for="playerSearch">search</label>
          <div class="ac">
            <input id="playerSearch" class="input" placeholder="输入选手名并回车" autocomplete="off" />
            <div class="suggest" id="playerSuggest"></div>
          </div>
          <button id="playerSearchBtn" class="btn">搜索</button>
          <button id="playerBack" class="btn secondary">返回首页</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="playerBody">
        <div class="playerHeader">
          <div class="playerTitle">
            <div class="avatar" id="avatar"></div>
            <div>
              <div class="playerName" id="playerName">-</div>
              <div class="playerMeta" id="playerTime">-</div>
            </div>
          </div>
          <div class="tiny">点击图片可放大查看</div>
        </div>

        <div class="picsGrid" id="picsGrid"></div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal" id="modal">
    <div class="box">
      <img id="modalImg" alt="preview" />
      <div class="bar">
        <div id="modalCap">picture</div>
        <button class="btn secondary" id="modalClose" style="height:34px; padding:0 10px; border-radius:10px;">关闭</button>
      </div>
    </div>
  </div>

  <script>
    // 口令（你可以改）
    const AUTHOR_PASSWORD = '3058924648';

    const DB_KEY = 'mzl_players_db_v2';
    const AUTH_KEY = 'mzl_author_authed_v1';

    const $ = (sel) => document.querySelector(sel);

    function toast(msg, ms=1800){
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(el._t);
      el._t = setTimeout(()=>el.classList.remove('show'), ms);
    }

    function loadDB(){
      try{ return JSON.parse(localStorage.getItem(DB_KEY) || '{}') || {}; }
      catch{ return {}; }
    }
    function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function isAuthed(){ return localStorage.getItem(AUTH_KEY) === '1'; }

    function setHidden(sel, hidden){ $(sel).hidden = hidden; }

    // 路由：#home / #admin / #player?name=
    function getHash(){
      const h = location.hash || '#home';
      const [path, qs] = h.split('?');
      const params = new URLSearchParams(qs || '');
      return { path, params };
    }

    // ===== 自动联想：候选（从已保存选手里找） =====
    function normalizeName(name){ return (name || '').trim(); }

    function getCandidates(query){
      const db = loadDB();
      const q = (query || '').trim().toLowerCase();
      if (!q) return [];

      const keys = Object.keys(db);
      let cand = keys
        .map(k => {
          const disp = (db[k]?.displayName || k).toString();
          return { key: k, displayName: disp };
        })
        .filter(x => x.key.includes(q) || x.displayName.toLowerCase().includes(q));

      // startsWith 更靠前，短的更靠前
      cand.sort((a, b) => {
        const aName = a.displayName.toLowerCase();
        const bName = b.displayName.toLowerCase();
        const aStarts = (a.key.startsWith(q) || aName.startsWith(q)) ? 1 : 0;
        const bStarts = (b.key.startsWith(q) || bName.startsWith(q)) ? 1 : 0;
        if (aStarts !== bStarts) return bStarts - aStarts;
        return aName.length - bName.length;
      });

      // 去重
      const seen = new Set();
      cand = cand.filter(x => {
        const t = x.displayName.toLowerCase();
        if (seen.has(t)) return false;
        seen.add(t);
        return true;
      });

      return cand.slice(0, 8);
    }

    // ===== 联想组件（通用）：传入点击回调 =====
    function attachSuggest(inputEl, suggestEl, onPick){
      function hide(){ suggestEl.classList.remove('show'); suggestEl.innerHTML = ''; }
      function show(items){
        if (!items.length){
          suggestEl.innerHTML = `<div class="suggestEmpty">没有匹配的选手</div>`;
          suggestEl.classList.add('show');
          return;
        }
        suggestEl.innerHTML = items.map(x => `
          <div class="sitem" data-name="${encodeURIComponent(x.displayName)}">
            <span>${x.displayName}</span>
            <small>${x.key}</small>
          </div>
        `).join('');
        suggestEl.classList.add('show');
      }

      inputEl.addEventListener('input', ()=>{
        const q = inputEl.value;
        if (!q.trim()) { hide(); return; }
        show(getCandidates(q));
      });

      // 点击候选（mousedown 防止 blur 先关闭）
      suggestEl.addEventListener('mousedown', (e)=>{
        const item = e.target.closest('.sitem');
        if (!item) return;
        const name = decodeURIComponent(item.dataset.name || '');
        inputEl.value = name;
        hide();
        onPick(name);
      });

      // Enter：默认第一个候选
      inputEl.addEventListener('keydown', (e)=>{
        if (e.key !== 'Enter') return;
        const q = inputEl.value;
        const items = getCandidates(q);
        if (items.length){
          e.preventDefault();
          hide();
          onPick(items[0].displayName);
        }else{
          onPick(q);
        }
      });

      inputEl.addEventListener('blur', ()=> setTimeout(hide, 120));
      document.addEventListener('click', (e)=>{
        if (e.target === inputEl || suggestEl.contains(e.target)) return;
        hide();
      });

      // 对外暴露 hide
      return { hide };
    }

    // ===== 清空搜索栏（跳转新界面时调用） =====
    function clearSearchBars(){
      const hs = $('#homeSearch');
      const ps = $('#playerSearch');
      if (hs) hs.value = '';
      if (ps) ps.value = '';
      // 建议框也顺便关掉
      if (window._homeSuggestCtl) window._homeSuggestCtl.hide();
      if (window._playerSuggestCtl) window._playerSuggestCtl.hide();
    }

    function route(){
      const { path, params } = getHash();

      // ✅ 每次跳转到新界面：清空搜索栏
      clearSearchBars();

      setHidden('#view-home', true);
      setHidden('#view-admin', true);
      setHidden('#view-player', true);

      if (path === '#admin'){
        if (!isAuthed()){
          location.hash = '#home';
          toast('未进入作者模式');
          return;
        }
        setHidden('#view-admin', false);
        return;
      }

      if (path === '#player'){
        setHidden('#view-player', false);
        renderPlayer((params.get('name') || '').trim());
        return;
      }

      setHidden('#view-home', false);
    }
    window.addEventListener('hashchange', route);

    // ===== 图片读取 + 压缩 =====
    function fileToImage(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    async function compressToDataURL(file, maxW, maxH, quality=0.85){
      const img = await fileToImage(file);
      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      const scale = Math.min(1, maxW / w, maxH / h);
      const cw = Math.max(1, Math.round(w * scale));
      const ch = Math.max(1, Math.round(h * scale));
      const canvas = document.createElement('canvas');
      canvas.width = cw;
      canvas.height = ch;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, cw, ch);
      return canvas.toDataURL('image/jpeg', quality);
    }

    // ===== 编辑状态（上传页） =====
    let editKey = '';
    let editState = { displayName:'', portrait:'', pictures:[], updatedAt:'' };

    function setPortraitPreview(dataURL){
      const box = $('#portraitPreview');
      box.innerHTML = dataURL ? `<img src="${dataURL}" alt="portrait">` : `<div class="ph">人像预览</div>`;
    }

    function renderAdminThumbs(){
      const grid = $('#adminThumbs');
      grid.innerHTML = '';
      const pics = editState.pictures || [];
      $('#picsCount').textContent = `当前已上传：${pics.length} 张`;
      if (!pics.length) return;

      pics.forEach((src, idx)=>{
        const d = document.createElement('div');
        d.className = 'thumb';
        d.innerHTML = `
          <img src="${src}" alt="pic${idx+1}">
          <div class="x" title="删除">×</div>
          <div class="badge">picture ${idx+1}</div>
        `;
        d.addEventListener('click', (e)=>{
          if (e.target.classList.contains('x')) return;
          openModal(src, `picture ${idx+1} · ${editState.displayName || ''}`);
        });
        d.querySelector('.x').addEventListener('click', (e)=>{
          e.stopPropagation();
          editState.pictures.splice(idx, 1);
          renderAdminThumbs();
        });
        grid.appendChild(d);
      });
    }

    function loadIntoAdmin(name){
      const n = normalizeName(name);
      if (!n){ toast('请先输入选手名'); return; }
      const db = loadDB();
      const key = n.toLowerCase();
      const rec = db[key];

      editKey = key;
      if (rec){
        editState = {
          displayName: rec.displayName || n,
          portrait: rec.portrait || '',
          pictures: Array.isArray(rec.pictures) ? rec.pictures.slice() : [],
          updatedAt: rec.updatedAt || ''
        };
        toast('已载入：' + editState.displayName);
      }else{
        editState = { displayName: n, portrait:'', pictures:[], updatedAt:'' };
        toast('新建选手：' + n);
      }

      $('#playerNameInput').value = editState.displayName;
      setPortraitPreview(editState.portrait);
      renderAdminThumbs();
    }

    // ===== 跳转到选手界面：优先完全匹配，否则模糊取第一个 =====
    function openPlayerByName(name){
      const n = normalizeName(name);
      if (!n){ toast('请输入选手名'); return; }

      const db = loadDB();
      const key = n.toLowerCase();

      if (db[key]) {
        location.hash = '#player?name=' + encodeURIComponent(db[key].displayName || n);
        return;
      }

      const cand = getCandidates(n);
      if (!cand.length){
        toast('未找到匹配：' + n);
        return;
      }
      location.hash = '#player?name=' + encodeURIComponent(cand[0].displayName);
    }

    // ===== HOME：按钮搜索 =====
    $('#homeSearchBtn').addEventListener('click', ()=>openPlayerByName($('#homeSearch').value));

    // HOME：进入作者模式
    $('#goUpload').addEventListener('click', ()=>{
      const pass = prompt('请输入作者口令：');
      if (pass === null) return;
      if (pass !== AUTHOR_PASSWORD){ toast('口令错误'); return; }
      localStorage.setItem(AUTH_KEY, '1');
      toast('进入作者模式');
      location.hash = '#admin';
    });

    // ADMIN：返回/退出
    $('#adminBack').addEventListener('click', ()=>location.hash='#home');
    $('#adminLogout').addEventListener('click', ()=>{
      localStorage.removeItem(AUTH_KEY);
      toast('已退出作者模式');
      location.hash = '#home';
    });

    // ADMIN：载入按钮
    $('#loadPlayer').addEventListener('click', ()=>loadIntoAdmin($('#playerNameInput').value));

    // ADMIN：人像上传（替换）
    $('#portraitFile').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const n = normalizeName($('#playerNameInput').value);
      if (!n){ toast('请先输入选手名'); e.target.value=''; return; }
      if (!editKey) loadIntoAdmin(n);

      try{
        toast('处理人像中…', 900);
        const data = await compressToDataURL(f, 720, 720, 0.86);
        editState.portrait = data;
        setPortraitPreview(editState.portrait);
      }catch{
        toast('人像读取失败');
      }
      e.target.value = '';
    });

    // ADMIN：图片上传（无限制，追加）
    $('#picsFile').addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files || []);
      if (!files.length) return;

      const n = normalizeName($('#playerNameInput').value);
      if (!n){
        toast('请先输入选手名');
        e.target.value = '';
        return;
      }
      if (!editKey) loadIntoAdmin(n);

      try{
        for (let i=0;i<files.length;i++){
          toast(`处理图片 ${i+1}/${files.length}…`, 900);
          const data = await compressToDataURL(files[i], 1600, 1000, 0.85);
          editState.pictures.push(data);
        }
        renderAdminThumbs();
        toast(`已添加 ${files.length} 张图片`);
      }catch(err){
        console.error(err);
        toast('图片处理失败（可能文件过大）');
      }
      e.target.value = '';
    });

    // ADMIN：保存
    $('#savePlayer').addEventListener('click', ()=>{
      const n = normalizeName($('#playerNameInput').value);
      if (!n){ toast('请输入选手名'); return; }
      const key = n.toLowerCase();
      const db = loadDB();

      editState.displayName = n;
      editState.updatedAt = new Date().toISOString();

      try{
        db[key] = {
          displayName: editState.displayName,
          portrait: editState.portrait || '',
          pictures: Array.isArray(editState.pictures) ? editState.pictures : [],
          updatedAt: editState.updatedAt
        };
        saveDB(db);
        editKey = key;
        toast('已保存：' + n);
      }catch(err){
        console.error(err);
        toast('保存失败：可能是浏览器存储空间不足');
      }
    });

    // ADMIN：预览第三界面
    $('#toPlayerView').addEventListener('click', ()=>{
      const n = normalizeName($('#playerNameInput').value);
      if (!n){ toast('请输入选手名'); return; }
      $('#savePlayer').click();
      location.hash = '#player?name=' + encodeURIComponent(n);
    });

    // ADMIN：删除选手
    $('#deletePlayer').addEventListener('click', ()=>{
      const n = normalizeName($('#playerNameInput').value);
      if (!n){ toast('请输入选手名'); return; }
      const key = n.toLowerCase();
      const db = loadDB();
      if (!db[key]){ toast('没有这个选手'); return; }
      if (!confirm('确定删除选手：' + n + ' ？')) return;
      delete db[key];
      saveDB(db);

      editKey = '';
      editState = { displayName:'', portrait:'', pictures:[], updatedAt:'' };
      $('#playerNameInput').value = '';
      setPortraitPreview('');
      renderAdminThumbs();
      toast('已删除：' + n);
    });

    // ===== PLAYER VIEW：渲染（展示上传几张就展示几张） =====
    function renderPlayer(name){
      const n = normalizeName(name);
      const db = loadDB();
      const rec = db[n.toLowerCase()];

      if (!n){
        $('#playerName').textContent = '未指定选手';
        $('#playerTime').textContent = '请从首页搜索或输入选手名';
        $('#avatar').innerHTML = '';
        $('#picsGrid').innerHTML = '';
        return;
      }

      if (!rec){
        $('#playerName').textContent = n;
        $('#playerTime').textContent = '未找到该选手，请联系作者上传';
        $('#avatar').innerHTML = '';
        $('#picsGrid').innerHTML = '';
        return;
      }

      $('#playerName').textContent = rec.displayName || n;
      $('#playerTime').textContent = rec.updatedAt ? ('更新时间：' + rec.updatedAt.replace('T',' ').slice(0,19)) : '';

      // ✅ 不再自动填充 playerSearch（因为你要求“跳转时清空搜索栏”）
      // $('#playerSearch').value = rec.displayName || n;

      $('#avatar').innerHTML = rec.portrait
        ? `<img src="${rec.portrait}" alt="portrait">`
        : `<div class="ph" style="width:100%;">暂无人像</div>`;

      const pics = Array.isArray(rec.pictures) ? rec.pictures : [];
      const grid = $('#picsGrid');
      grid.innerHTML = '';

      if (!pics.length){
        grid.innerHTML = `<div class="tiny">该选手暂无上传图片。</div>`;
        return;
      }

      pics.forEach((src, idx)=>{
        const card = document.createElement('div');
        card.className = 'picCard';
        card.innerHTML = `
          <div style="aspect-ratio:16/9; background:rgba(0,0,0,.22); display:flex; align-items:center; justify-content:center;">
            <img src="${src}" alt="picture${idx+1}" style="width:100%; height:100%; object-fit:cover; display:block;">
          </div>
          <div class="cap"><span>picture ${idx+1}</span><span>点击放大</span></div>
        `;
        card.addEventListener('click', ()=>openModal(src, `picture ${idx+1} · ${rec.displayName || n}`));
        grid.appendChild(card);
      });
    }

    // PLAYER：搜索按钮 / 返回
    $('#playerSearchBtn').addEventListener('click', ()=>openPlayerByName($('#playerSearch').value));
    $('#playerBack').addEventListener('click', ()=>location.hash='#home');

    // ===== Modal =====
    function openModal(src, cap){
      $('#modalImg').src = src;
      $('#modalCap').textContent = cap;
      $('#modal').classList.add('show');
    }
    function closeModal(){ $('#modal').classList.remove('show'); }
    $('#modalClose').addEventListener('click', closeModal);
    $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // ===== 初始化：路由 + 绑定联想（Home/Player/Admin） =====
    route();

    // Home：点候选/Enter -> 跳转
    window._homeSuggestCtl = attachSuggest(
      document.getElementById('homeSearch'),
      document.getElementById('homeSuggest'),
      (name) => openPlayerByName(name)
    );

    // Player：点候选/Enter -> 跳转
    window._playerSuggestCtl = attachSuggest(
      document.getElementById('playerSearch'),
      document.getElementById('playerSuggest'),
      (name) => openPlayerByName(name)
    );

    // Admin：点候选/Enter -> 载入（不是跳转）
    window._adminSuggestCtl = attachSuggest(
      document.getElementById('playerNameInput'),
      document.getElementById('adminSuggest'),
      (name) => loadIntoAdmin(name)
    );
  </script>
</body>
</html>