<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <title>木子李 - 选手图片检索</title>

  <style>
    :root{
      --bg-img: url('https://img-cdn.hltv.org/gallerypicture/R3WtpF7rXq_6JieFCx4_tG.jpg?auto=compress&ixlib=java-2.1.0&m=%2Fm.png&mw=1049&mx=194&my=4662&q=75&s=355ec1de37f8129c7ab88972a0623e3b&w=7876');
      --text: #eaf0ff;
      --muted: rgba(234,240,255,.74);
      --panel: rgba(10, 14, 26, .58);
      --line: rgba(255,255,255,.14);
      --accent: #7aa2ff;
      --danger: #ff6b6b;
      --ok: #7ae582;
      --radius: 18px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      color: var(--text);
      overflow-x:hidden;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image: var(--bg-img);
      background-size: cover;
      background-position: center;
      background-repeat:no-repeat;
      filter: saturate(1.05) contrast(1.05);
      transform: scale(1.03);
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(122,162,255,.30), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(200,120,255,.26), transparent 55%),
        linear-gradient(180deg, rgba(4,6,12,.72), rgba(4,6,12,.82));
      z-index:-1;
    }

    .wrap{ width:min(1100px, 92vw); margin: 26px auto 42px; }
    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      padding: 18px 18px 14px;
      flex-wrap:wrap;
    }
    .brand{ display:flex; flex-direction:column; gap:10px; line-height:1.2; }
    .brand .big{ font-size: 30px; font-weight: 900; letter-spacing: .6px; }
    .brand .sub{ color: var(--muted); font-size: 14px; }

    .searchArea{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .searchArea label{ color: var(--muted); font-size: 14px; }

    .input{
      height: 44px;
      padding: 0 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
      width: min(360px, 72vw);
    }
    .input::placeholder{ color: rgba(234,240,255,.55); }
    .input:focus{ border-color: rgba(122,162,255,.7); box-shadow: 0 0 0 3px rgba(122,162,255,.18); }

    .btn{
      height: 44px;
      padding: 0 14px;
      border-radius: 12px;
      border:1px solid rgba(122,162,255,.55);
      background: rgba(122,162,255,.16);
      color: var(--text);
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ background: rgba(122,162,255,.24); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ border-color: var(--line); background: rgba(255,255,255,.06); }
    .btn.secondary:hover{ background: rgba(255,255,255,.10); }
    .btn.danger{ border-color: rgba(255,107,107,.55); background: rgba(255,107,107,.14); }
    .btn.danger:hover{ background: rgba(255,107,107,.22); }
    .btn.ok{ border-color: rgba(122,229,130,.55); background: rgba(122,229,130,.14); }
    .btn.ok:hover{ background: rgba(122,229,130,.20); }

    .divider{ height:1px; background: rgba(255,255,255,.10); }

    /* HOME */
    .homeBody{ padding: 16px 18px 18px; }
    .uploadRow{ display:flex; align-items:center; justify-content:flex-start; gap:12px; flex-wrap:wrap; }
    .note{ color: var(--muted); font-size: 13px; }
    .bottomQQ{ margin-top: 20px; text-align:center; color: rgba(234,240,255,.78); font-size: 14px; padding: 12px 10px 18px; }

    /* ADMIN */
    .adminBody{ padding: 16px 18px 18px; }
    .formGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 900px){
      .formGrid{ grid-template-columns: 1fr; }
      .brand .big{ font-size: 26px; }
    }
    .card{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding: 14px;
    }
    .card h3{ margin:0 0 10px; font-size: 15px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .help{ color: var(--muted); font-size: 12.5px; line-height: 1.55; }
    .tiny{ color: rgba(234,240,255,.60); font-size: 12px; line-height: 1.45; }

    .previewSquare{
      width: 180px;
      aspect-ratio: 1/1;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-top: 10px;
    }
    .previewSquare img{ width:100%; height:100%; object-fit: cover; display:block; }
    .ph{ color: rgba(234,240,255,.60); font-size: 12px; text-align:center; padding: 10px; }

    .fileBox{
      margin-top: 10px;
      border:1px dashed rgba(255,255,255,.22);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,.05);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .fileBox input[type="file"]{ width:100%; }

    .thumbGrid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){ .thumbGrid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 650px){ .thumbGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .thumb{
      position:relative;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      aspect-ratio: 16/10;
      cursor:pointer;
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; display:block; }
    .thumb .x{
      position:absolute;
      top:8px; right:8px;
      height:28px; width:28px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      color: rgba(255,255,255,.9);
      display:grid;
      place-items:center;
      font-weight:900;
      cursor:pointer;
    }
    .thumb .badge{
      position:absolute;
      left:8px; bottom:8px;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.55);
      font-size: 12px;
      color: rgba(234,240,255,.88);
    }

    .adminActions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
    }

    .pathBox{
      margin-top: 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      background: rgba(0,0,0,.18);
    }
    .pathBox code{
      display:block;
      white-space:pre-wrap;
      word-break:break-word;
      color: rgba(234,240,255,.86);
      font-size: 12.5px;
      line-height: 1.55;
    }

    /* PLAYER */
    .playerBody{ padding: 16px 18px 18px; }
    .playerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      padding-bottom: 12px;
    }
    .playerTitle{ display:flex; align-items:center; gap: 12px; }
    .avatar{
      width: 76px; height: 76px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.18);
      overflow:hidden;
      background: rgba(0,0,0,.25);
    }
    .avatar img{ width:100%; height:100%; object-fit: cover; display:block; }
    .playerName{ font-size: 22px; font-weight: 900; letter-spacing:.4px; }
    .playerMeta{ color: var(--muted); font-size: 12.5px; margin-top: 2px; }

    .picsGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      margin-top: 10px;
    }

    .picCard{
      border:1px solid rgba(255,255,255,.14);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
      cursor:pointer;
    }
    .picCard .cap{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color: rgba(234,240,255,.78);
      font-size: 12.5px;
      border-top:1px solid rgba(255,255,255,.10);
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      color: var(--text);
      font-size: 13px;
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-6px); }

    /* Modal */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 1000;
    }
    .modal.show{ display:flex; }
    .modal .box{
      width: min(980px, 96vw);
      border-radius: 18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.25);
    }
    .modal img{ width:100%; height:auto; display:block; }
    .modal .bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      color: rgba(234,240,255,.8);
      font-size: 12.5px;
    }

    /* ===== AutoComplete 联想（Home / Player / Admin） ===== */
    .ac{ position: relative; width: min(360px, 72vw); }
    .ac.grow{ flex: 1; min-width: 240px; }
    .ac .input{ width: 100%; }

    .suggest{
      position: absolute;
      top: 48px;
      left: 0;
      width: 100%;
      display: none;
      z-index: 200;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .suggest.show{ display:block; }
    .sitem{
      padding: 10px 12px;
      cursor: pointer;
      font-size: 13.5px;
      color: rgba(234,240,255,.92);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sitem small{ color: rgba(234,240,255,.60); font-size: 12px; }
    .sitem:hover{ background: rgba(122,162,255,.18); }
    .suggestEmpty{
      padding: 10px 12px;
      color: rgba(234,240,255,.65);
      font-size: 12.5px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- HOME -->
    <section id="view-home" class="panel" hidden>
      <div class="topbar">
        <div class="brand">
          <div class="big">木子李欢迎您</div>
          <div class="sub">搜索栏输入相关选手可获得图片</div>
          <div class="sub">上传仅作者使用</div>
        </div>

        <div class="searchArea">
          <label for="homeSearch">search</label>
          <div class="ac">
            <input id="homeSearch" class="input" placeholder="例如：monesy" autocomplete="off" />
            <div class="suggest" id="homeSuggest"></div>
          </div>
          <button id="homeSearchBtn" class="btn">搜索</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="homeBody">
        <div class="uploadRow">
          <button id="goUpload" class="btn secondary">上传（仅作者使用）</button>
          <div class="note">公开展示数据来自仓库文件 <b>data/players.json</b>（所有人共享可见）。</div>
        </div>
        <div class="bottomQQ">作者QQ：3058924648</div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="panel" hidden>
      <div class="topbar">
        <div class="brand">
          <div class="big">作者上传区</div>
          <div class="sub">导出标准命名图片 + 生成 players.json（再上传到 GitHub）</div>
        </div>
        <div class="searchArea">
          <button id="adminBack" class="btn secondary">返回首页</button>
          <button id="adminLogout" class="btn danger">退出作者模式</button>
        </div>
      </div>
      <div class="divider"></div>

      <div class="adminBody">
        <div class="formGrid">
          <!-- 左：选手信息 -->
          <div class="card">
            <h3>1) 选手信息（支持模糊匹配）</h3>
            <div class="row">
              <div class="ac grow">
                <input id="playerNameInput" class="input" placeholder="输入选手名（例如：monesy）" autocomplete="off" />
                <div class="suggest" id="adminSuggest"></div>
              </div>
              <button id="loadPlayer" class="btn secondary">载入</button>
            </div>

            <div class="help" style="margin-top:10px;">
              说明：此“上传”不会直接写入 GitHub。你需要把导出的图片与 players.json 手动上传到仓库。
            </div>

            <div class="fileBox">
              <div class="tiny">人像（将导出为 portrait.jpg）</div>
              <input id="portraitFile" type="file" accept="image/*" />
              <div class="previewSquare" id="portraitPreview"><div class="ph">人像预览</div></div>
            </div>

            <div class="pathBox">
              <div class="tiny">标准路径（上传到仓库后网页将从这里读取）：</div>
              <code id="stdPaths">assets/players/&lt;player&gt;/portrait.jpg\nassets/players/&lt;player&gt;/1.jpg ...</code>
            </div>

            <div class="tiny" style="margin-top:10px;">
              <b>发布步骤：</b><br>
              ① 选手名 → 选择人像/图片 → 点击“导出图片（下载）”<br>
              ② 把下载得到的 portrait.jpg、1.jpg、2.jpg... 上传到仓库：<b>assets/players/选手名/</b><br>
              ③ 点击“下载 players.json”，上传覆盖仓库：<b>data/players.json</b><br>
              ④ 所有人刷新即可看到更新
            </div>
          </div>

          <!-- 右：图片（无限制） -->
          <div class="card">
            <h3>2) 上传图片（无限制）</h3>
            <div class="help">一次选多张，导出后会按 1.jpg、2.jpg… 命名（更省事）。缩略图右上角 × 可移除。</div>

            <div class="fileBox">
              <input id="picsFile" type="file" accept="image/*" multiple />
              <div id="picsCount" class="tiny">当前已选择：0 张</div>
            </div>

            <div id="adminThumbs" class="thumbGrid"></div>

            <div class="adminActions">
              <button id="exportImages" class="btn ok">导出图片（下载标准命名）</button>
              <button id="savePlayer" class="btn">写入 players.json（内存）</button>
              <button id="downloadPlayersJson" class="btn secondary">下载 players.json</button>
              <button id="toPlayerView" class="btn secondary">预览第三界面</button>
              <button id="deletePlayer" class="btn danger">从 players.json 删除该选手</button>
            </div>

            <div class="tiny" id="adminStatus" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- PLAYER -->
    <section id="view-player" class="panel" hidden>
      <div class="topbar">
        <div class="brand">
          <div class="big">选手图片</div>
          <div class="sub">数据来源：data/players.json（所有人共享）</div>
        </div>

        <div class="searchArea">
          <label for="playerSearch">search</label>
          <div class="ac">
            <input id="playerSearch" class="input" placeholder="输入选手名并回车" autocomplete="off" />
            <div class="suggest" id="playerSuggest"></div>
          </div>
          <button id="playerSearchBtn" class="btn">搜索</button>
          <button id="playerBack" class="btn secondary">返回首页</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="playerBody">
        <div class="playerHeader">
          <div class="playerTitle">
            <div class="avatar" id="avatar"></div>
            <div>
              <div class="playerName" id="playerName">-</div>
              <div class="playerMeta" id="playerTime">-</div>
            </div>
          </div>
          <div class="tiny">点击图片可放大查看</div>
        </div>

        <div class="picsGrid" id="picsGrid"></div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal" id="modal">
    <div class="box">
      <img id="modalImg" alt="preview" />
      <div class="bar">
        <div id="modalCap">picture</div>
        <button class="btn secondary" id="modalClose" style="height:34px; padding:0 10px; border-radius:10px;">关闭</button>
      </div>
    </div>
  </div>

  <script>
    // ===== 配置 =====
    const AUTHOR_PASSWORD = '3058924648';
    const AUTH_KEY = 'mzl_author_authed_public_v1';

    // 公开数据源（仓库中）
    const DB_URL = './data/players.json';

    const $ = (sel) => document.querySelector(sel);

    function toast(msg, ms=1800){
      const el = $('#toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(el._t);
      el._t = setTimeout(()=>el.classList.remove('show'), ms);
    }

    // ===== 远程DB（内存）=====
    let REMOTE_DB = {};     // {key: {displayName, portrait, pictures[], updatedAt}}
    let DB_LOADED = false;

    function normalizeName(name){ return (name || '').trim(); }
    function toKey(name){ return normalizeName(name).toLowerCase(); }

    async function loadRemoteDB(){
      try{
        const url = DB_URL + (DB_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        REMOTE_DB = data && typeof data === 'object' ? data : {};
        DB_LOADED = true;
        return true;
      }catch(err){
        console.error(err);
        REMOTE_DB = {};
        DB_LOADED = false;
        return false;
      }
    }

    function isAuthed(){ return sessionStorage.getItem(AUTH_KEY) === '1'; }

    function setHidden(sel, hidden){ $(sel).hidden = hidden; }

    // ===== 路由：#home / #admin / #player?name= =====
    function getHash(){
      const h = location.hash || '#home';
      const [path, qs] = h.split('?');
      const params = new URLSearchParams(qs || '');
      return { path, params };
    }

    function clearSearchBars(){
      const hs = $('#homeSearch');
      const ps = $('#playerSearch');
      if (hs) hs.value = '';
      if (ps) ps.value = '';
      if (window._homeCtl) window._homeCtl.hide();
      if (window._playerCtl) window._playerCtl.hide();
    }

    async function route(){
      const { path, params } = getHash();
      clearSearchBars();

      setHidden('#view-home', true);
      setHidden('#view-admin', true);
      setHidden('#view-player', true);

      // 每次路由都尝试拉取最新DB（让你刚上传 players.json 后刷新就生效）
      await loadRemoteDB();

      if (!DB_LOADED){
        toast('提示：未加载到 data/players.json（请确认仓库里已创建该文件）', 2600);
      }

      if (path === '#admin'){
        if (!isAuthed()){
          location.hash = '#home';
          toast('未进入作者模式');
          return;
        }
        setHidden('#view-admin', false);
        // 进入作者页时，刷新联想数据
        refreshSuggest();
        return;
      }

      if (path === '#player'){
        setHidden('#view-player', false);
        renderPlayer((params.get('name') || '').trim());
        refreshSuggest();
        return;
      }

      setHidden('#view-home', false);
      refreshSuggest();
    }
    window.addEventListener('hashchange', route);

    // ===== 模糊候选（从 REMOTE_DB）=====
    function listPlayers(){
      const keys = Object.keys(REMOTE_DB || {});
      return keys.map(k => ({
        key: k,
        displayName: (REMOTE_DB[k]?.displayName || k).toString()
      }));
    }

    function getCandidates(query){
      const q = (query || '').trim().toLowerCase();
      if (!q) return [];
      const arr = listPlayers();
      let cand = arr.filter(x => x.key.includes(q) || x.displayName.toLowerCase().includes(q));

      cand.sort((a, b) => {
        const aName = a.displayName.toLowerCase();
        const bName = b.displayName.toLowerCase();
        const aStarts = (a.key.startsWith(q) || aName.startsWith(q)) ? 1 : 0;
        const bStarts = (b.key.startsWith(q) || bName.startsWith(q)) ? 1 : 0;
        if (aStarts !== bStarts) return bStarts - aStarts;
        return aName.length - bName.length;
      });

      const seen = new Set();
      cand = cand.filter(x => {
        const t = x.displayName.toLowerCase();
        if (seen.has(t)) return false;
        seen.add(t);
        return true;
      });

      return cand.slice(0, 8);
    }

    function attachSuggest(inputEl, suggestEl, onPick){
      function hide(){ suggestEl.classList.remove('show'); suggestEl.innerHTML = ''; }
      function show(items){
        if (!items.length){
          suggestEl.innerHTML = `<div class="suggestEmpty">没有匹配的选手</div>`;
          suggestEl.classList.add('show');
          return;
        }
        suggestEl.innerHTML = items.map(x => `
          <div class="sitem" data-name="${encodeURIComponent(x.displayName)}">
            <span>${x.displayName}</span>
            <small>${x.key}</small>
          </div>
        `).join('');
        suggestEl.classList.add('show');
      }

      inputEl.addEventListener('input', ()=>{
        const q = inputEl.value;
        if (!q.trim()) { hide(); return; }
        show(getCandidates(q));
      });

      suggestEl.addEventListener('mousedown', (e)=>{
        const item = e.target.closest('.sitem');
        if (!item) return;
        const name = decodeURIComponent(item.dataset.name || '');
        inputEl.value = name;
        hide();
        onPick(name);
      });

      inputEl.addEventListener('keydown', (e)=>{
        if (e.key !== 'Enter') return;
        const q = inputEl.value;
        const items = getCandidates(q);
        if (items.length){
          e.preventDefault();
          hide();
          onPick(items[0].displayName);
        }else{
          onPick(q);
        }
      });

      inputEl.addEventListener('blur', ()=> setTimeout(hide, 120));
      document.addEventListener('click', (e)=>{
        if (e.target === inputEl || suggestEl.contains(e.target)) return;
        hide();
      });

      return { hide };
    }

    function refreshSuggest(){
      // 不需要重新绑定事件；这里只是为了让联想使用的 REMOTE_DB 是最新的
      // attachSuggest 内部使用 getCandidates -> 读 REMOTE_DB（实时）
    }

    // ===== 跳转展示页 =====
    function resolvePlayer(name){
      const n = normalizeName(name);
      if (!n) return null;

      const k = toKey(n);
      if (REMOTE_DB[k]) return { key: k, rec: REMOTE_DB[k] };

      const cand = getCandidates(n);
      if (!cand.length) return null;
      const hitKey = cand[0].key;
      return { key: hitKey, rec: REMOTE_DB[hitKey] };
    }

    function openPlayerByName(name){
      const hit = resolvePlayer(name);
      if (!hit){
        toast('未找到匹配：' + normalizeName(name));
        return;
      }
      location.hash = '#player?name=' + encodeURIComponent(hit.rec.displayName || hit.key);
    }

    // ===== HOME 行为 =====
    $('#homeSearchBtn').addEventListener('click', ()=>openPlayerByName($('#homeSearch').value));
    $('#goUpload').addEventListener('click', ()=>{
      const pass = prompt('请输入作者口令：');
      if (pass === null) return;
      if (pass !== AUTHOR_PASSWORD){ toast('口令错误'); return; }
      sessionStorage.setItem(AUTH_KEY, '1');
      toast('进入作者模式');
      location.hash = '#admin';
    });

    // ===== PLAYER 行为 =====
    $('#playerSearchBtn').addEventListener('click', ()=>openPlayerByName($('#playerSearch').value));
    $('#playerBack').addEventListener('click', ()=>location.hash='#home');

    // ===== Modal =====
    function openModal(src, cap){
      $('#modalImg').src = src;
      $('#modalCap').textContent = cap;
      $('#modal').classList.add('show');
    }
    function closeModal(){ $('#modal').classList.remove('show'); }
    $('#modalClose').addEventListener('click', closeModal);
    $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    // ===== PLAYER 渲染（来自 players.json）=====
    function renderPlayer(name){
      const hit = resolvePlayer(name);
      const grid = $('#picsGrid');
      grid.innerHTML = '';

      if (!hit){
        $('#playerName').textContent = normalizeName(name) || '未指定选手';
        $('#playerTime').textContent = DB_LOADED ? '未找到该选手，请联系作者上传' : '未加载到 players.json';
        $('#avatar').innerHTML = '';
        return;
      }

      const { key, rec } = hit;
      $('#playerName').textContent = rec.displayName || key;
      $('#playerTime').textContent = rec.updatedAt ? ('更新时间：' + String(rec.updatedAt)) : '';

      $('#avatar').innerHTML = rec.portrait
        ? `<img src="${rec.portrait}" alt="portrait">`
        : `<div class="ph" style="width:100%;">暂无人像</div>`;

      const pics = Array.isArray(rec.pictures) ? rec.pictures : [];
      if (!pics.length){
        grid.innerHTML = `<div class="tiny">该选手暂无上传图片。</div>`;
        return;
      }

      pics.forEach((src, idx)=>{
        const card = document.createElement('div');
        card.className = 'picCard';
        card.innerHTML = `
          <div style="aspect-ratio:16/9; background:rgba(0,0,0,.22); display:flex; align-items:center; justify-content:center;">
            <img src="${src}" alt="picture${idx+1}" style="width:100%; height:100%; object-fit:cover; display:block;">
          </div>
          <div class="cap"><span>picture ${idx+1}</span><span>点击放大</span></div>
        `;
        card.addEventListener('click', ()=>openModal(src, `picture ${idx+1} · ${rec.displayName || key}`));
        grid.appendChild(card);
      });
    }

    // ===== ADMIN：编辑状态（内存，最终导出 players.json）=====
    let editKey = '';
    let editState = { displayName:'', portrait:'', pictures:[], updatedAt:'' };

    function setPortraitPreview(dataURL){
      const box = $('#portraitPreview');
      box.innerHTML = dataURL ? `<img src="${dataURL}" alt="portrait">` : `<div class="ph">人像预览</div>`;
    }

    function updateStdPaths(){
      const name = normalizeName($('#playerNameInput').value) || '<player>';
      const key = toKey(name) || '<player>';
      $('#stdPaths').textContent =
`assets/players/${key}/portrait.jpg
assets/players/${key}/1.jpg
assets/players/${key}/2.jpg
...`;
    }

    function renderAdminThumbs(){
      const grid = $('#adminThumbs');
      grid.innerHTML = '';
      const pics = editState.pictures || [];
      $('#picsCount').textContent = `当前已选择：${pics.length} 张`;
      if (!pics.length) return;

      pics.forEach((src, idx)=>{
        const d = document.createElement('div');
        d.className = 'thumb';
        d.innerHTML = `
          <img src="${src}" alt="pic${idx+1}">
          <div class="x" title="移除">×</div>
          <div class="badge">picture ${idx+1}</div>
        `;
        d.addEventListener('click', (e)=>{
          if (e.target.classList.contains('x')) return;
          openModal(src, `picture ${idx+1} · ${editState.displayName || ''}`);
        });
        d.querySelector('.x').addEventListener('click', (e)=>{
          e.stopPropagation();
          editState.pictures.splice(idx, 1);
          renderAdminThumbs();
        });
        grid.appendChild(d);
      });
    }

    function loadIntoAdmin(name){
      const n = normalizeName(name);
      if (!n){ toast('请先输入选手名'); return; }

      const key = toKey(n);
      editKey = key;

      const rec = REMOTE_DB[key];
      if (rec){
        editState = {
          displayName: rec.displayName || n,
          portrait: rec.portrait || '',
          pictures: Array.isArray(rec.pictures) ? rec.pictures.slice() : [],
          updatedAt: rec.updatedAt || ''
        };
        toast('已载入：' + editState.displayName);
      }else{
        editState = { displayName: n, portrait:'', pictures:[], updatedAt:'' };
        toast('新建选手：' + n);
      }

      $('#playerNameInput').value = editState.displayName;
      setPortraitPreview(editState.portrait);
      renderAdminThumbs();
      updateStdPaths();
      $('#adminStatus').textContent = '';
    }

    // ADMIN：返回/退出
    $('#adminBack').addEventListener('click', ()=>location.hash='#home');
    $('#adminLogout').addEventListener('click', ()=>{
      sessionStorage.removeItem(AUTH_KEY);
      toast('已退出作者模式');
      location.hash = '#home';
    });

    $('#loadPlayer').addEventListener('click', ()=>loadIntoAdmin($('#playerNameInput').value));
    $('#playerNameInput').addEventListener('input', updateStdPaths);

    // ===== 选择本地文件预览（仅用于导出/预览，不会直接发布）=====
    async function fileToImage(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function compressToBlob(file, maxW, maxH, quality=0.85){
      const img = await fileToImage(file);
      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      const scale = Math.min(1, maxW / w, maxH / h);
      const cw = Math.max(1, Math.round(w * scale));
      const ch = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = cw;
      canvas.height = ch;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, cw, ch);

      return new Promise((resolve)=>canvas.toBlob((b)=>resolve(b), 'image/jpeg', quality));
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1200);
    }

    // 本地文件暂存（用于导出）
    let portraitLocalFile = null;
    let picsLocalFiles = [];

    $('#portraitFile').addEventListener('change', (e)=>{
      portraitLocalFile = e.target.files?.[0] || null;
      if (portraitLocalFile){
        const reader = new FileReader();
        reader.onload = ()=>{ editState.portrait = reader.result; setPortraitPreview(editState.portrait); };
        reader.readAsDataURL(portraitLocalFile);
      }
      e.target.value = '';
    });

    $('#picsFile').addEventListener('change', (e)=>{
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      picsLocalFiles.push(...files);

      // 用 dataURL 做预览
      files.forEach(f=>{
        const reader = new FileReader();
        reader.onload = ()=>{ editState.pictures.push(reader.result); renderAdminThumbs(); };
        reader.readAsDataURL(f);
      });

      e.target.value = '';
    });

    // 导出图片（下载标准命名）
    $('#exportImages').addEventListener('click', async ()=>{
      const n = normalizeName($('#playerNameInput').value);
      if (!n){ toast('请先输入选手名'); return; }
      const key = toKey(n);
      if (!key){ toast('选手名无效'); return; }

      if (!portraitLocalFile && picsLocalFiles.length === 0){
        toast('请先选择人像/图片'); return;
      }

      toast('正在导出图片…', 1200);

      try{
        // portrait.jpg
        if (portraitLocalFile){
          const blob = await compressToBlob(portraitLocalFile, 720, 720, 0.86);
          downloadBlob(blob, 'portrait.jpg');
          // 同步将“公开路径”写入 editState（用于 players.json）
          editState.portrait = `assets/players/${key}/portrait.jpg`;
        }

        // 1.jpg,2.jpg,...
        if (picsLocalFiles.length){
          for (let i=0;i<picsLocalFiles.length;i++){
            const blob = await compressToBlob(picsLocalFiles[i], 1600, 1000, 0.85);
            downloadBlob(blob, `${i+1}.jpg`);
          }
          editState.pictures = Array.from({length: picsLocalFiles.length}, (_,i)=>`assets/players/${key}/${i+1}.jpg`);
          renderAdminThumbs(); // 注意：这里会把缩略图变成“路径字符串”，因此不再预览；属于预期行为（进入发布状态）
        }

        $('#adminStatus').textContent =
          `已导出：portrait.jpg 与 ${picsLocalFiles.length} 张图片（1.jpg...）。请上传到仓库 assets/players/${key}/`;

        toast('导出完成（请上传到 GitHub）');
      }catch(err){
        console.error(err);
        toast('导出失败：可能浏览器不支持或图片损坏');
      }
    });

    // 写入 players.json（内存）
    $('#savePlayer').addEventListener('click', ()=>{
      const n = normalizeName($('#playerNameInput').value);
      if (!n){ toast('请输入选手名'); return; }
      const key = toKey(n);

      editState.displayName = n;
      editState.updatedAt = new Date().toISOString().replace('T',' ').slice(0,19);

      REMOTE_DB[key] = {
        displayName: editState.displayName,
        portrait: editState.portrait || '',
        pictures: Array.isArray(editState.pictures) ? editState.pictures : [],
        updatedAt: editState.updatedAt
      };

      toast('已写入内存 players.json：' + n);
      $('#adminStatus').textContent = `已写入 players.json 内存（请点击“下载 players.json”并上传覆盖 data/players.json）`;
    });

    // 下载 players.json
    $('#downloadPlayersJson').addEventListener('click', ()=>{
      const json = JSON.stringify(REMOTE_DB, null, 2);
      const blob = new Blob([json], { type: 'application/json;charset=utf-8' });
      downloadBlob(blob, 'players.json');
      toast('已下载 players.json（上传到 data/players.json 覆盖即可）');
    });

    // 预览第三界面（用当前内存 DB）
    $('#toPlayerView').addEventListener('click', ()=>{
      const n = normalizeName($('#playerNameInput').value);
      if (!n){ toast('请输入选手名'); return; }
      // 先写入内存
      $('#savePlayer').click();
      location.hash = '#player?name=' + encodeURIComponent(n);
    });

    // 删除
    $('#deletePlayer').addEventListener('click', ()=>{
      const n = normalizeName($('#playerNameInput').value);
      if (!n){ toast('请输入选手名'); return; }
      const key = toKey(n);
      if (!REMOTE_DB[key]){ toast('players.json 中不存在该选手'); return; }
      if (!confirm('确定从 players.json 删除选手：' + n + ' ？')) return;
      delete REMOTE_DB[key];
      toast('已从内存 players.json 删除（记得下载并上传 players.json）');
      $('#adminStatus').textContent = '已删除（请点击“下载 players.json”并上传覆盖 data/players.json）';
    });

    // ===== 初始化联想（Home/Player/Admin）=====
    async function init(){
      await loadRemoteDB();
      route();

      window._homeCtl = attachSuggest($('#homeSearch'), $('#homeSuggest'), (name)=>openPlayerByName(name));
      window._playerCtl = attachSuggest($('#playerSearch'), $('#playerSuggest'), (name)=>openPlayerByName(name));
      window._adminCtl = attachSuggest($('#playerNameInput'), $('#adminSuggest'), (name)=>loadIntoAdmin(name));
    }

    init();
  </script>
</body>
</html>
